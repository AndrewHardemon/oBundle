---
category:
    shop_by_price: true
    products:
        limit: {{theme_settings.categorypage_products_per_page}}
cart:
    ok: true
---
{{inject "categoryProductsPerPage" theme_settings.categorypage_products_per_page}}
{{#partial "head"}}
    {{#if pagination.category.previous}}
        <link rel="prev" href="{{pagination.category.previous}}">
    {{/if}}
    {{#if pagination.category.next}}
        <link rel="next" href="{{pagination.category.next}}">
    {{/if}}
{{/partial}}

{{#partial "page"}}

{{> components/common/breadcrumbs breadcrumbs=breadcrumbs}}
{{#if category.image}}
    {{> components/common/responsive-img
        image=category.image
        fallback_size=theme_settings.zoom_size
        lazyload=theme_settings.lazyload_mode
        class="category-header-image"
    }}
{{/if}}
{{#if customer}}
    <div class="page-heading-banner">
        {{log this.customer.id}}
        {{!-- {{log this.category.total_products}} --}}
        {{!-- {{log this.cart}} --}}
        <p class="page-heading-banner__text">Hello {{customer.name}}! Welcome to {{category.name}}</p>
        <button id="add-all-products">Add All</button>
        {{#if this.cart.quantity}}
            <button id="remove-all-products">Remove All</button>
        {{/if}}
    </div>
{{/if}}
{{#unless theme_settings.hide_category_page_heading }}
    <h1 class="page-heading">{{category.name}}</h1>
    {{{region name="category_below_header"}}}
{{/unless}}
{{{category.description}}}
<div class="page">
    {{#if category.faceted_search_enabled}}
        <aside class="page-sidebar" id="faceted-search-container">
            {{> components/category/sidebar}}
        </aside>
    {{else if category.subcategories}}
        <aside class="page-sidebar" id="faceted-search-container">
            {{> components/category/sidebar}}
        </aside>
    {{else if category.shop_by_price}}
        {{#if theme_settings.shop_by_price_visibility}}
             <aside class="page-sidebar" id="faceted-search-container">
                {{> components/category/sidebar}}
            </aside>
        {{/if}}
    {{/if}}

    <div class="page-content" id="product-listing-container">
        {{> components/category/product-listing}}
        {{{region name="category_below_content"}}}
    </div>
</div>

{{/partial}}
{{> layout/base}}
<script>
    (async () => { 
        //? Alternate way to get cart
        const response = await fetch('/api/storefront/cart', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        const carts = await response.json()
        console.log(carts)

        const cart = carts[0]//.find(user => user.customer_id == "{{this.customer.id}}")
        if(!cart) return;
        let cartList = cart.lineItems

        cartList = cartList.customItems.concat(cartList.digitalItems, cartList.giftCertificates, cartList.physicalItems)
        const items = cartList.map(item => ({id: item.id, productId: item.productId}))
        console.log(items)

        let prod = `{{#each this.category.products as |product|}}{{product.id}},{{/each}}`
        let prodList = prod.split(",").splice(0, prod.split(",").length - 1).map(item => ({quantity: 1, productId: item.trim(), variantId: null}))
        console.log(prodList)

        let finalList = [];
        prodList.forEach((item, i) => {
            let cartItem = items.find(cartItem => cartItem.productId == item.productId)
            if(cartItem){
                finalList.push(cartItem.id)
            }
        })
        console.log(finalList)

        // Add All Products
        const addAll = document.querySelector('#add-all-products')
        addAll.addEventListener("click", async function(){
            console.log(prodList)
            const options = {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
                body: JSON.stringify({lineItems: prodList})
            };

            try {
                const response = await fetch('/api/storefront/carts/{{this.cart_id}}/items', options)
                const result = await response.json()
                console.log(response)
                location.reload()
            } catch (error) {
                console.log(error)
            }
        })

        //Remove All Products
        const removeAll = document.querySelector('#remove-all-products')
        removeAll.addEventListener("click", async function(){
            const options = {
                method: 'DELETE',
                // credentials: "same-origin",
                headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'}
            };
            try {

                function recursiveCall(finalList){
                    if(finalList.length == 0) location.reload();
                    const result = fetch(`/api/storefront/carts/{{this.cart_id}}/items/${finalList[0]}`, options)
                    .then(res=> res.json())
                    .then(data => {
                        console.log(data)
                        finalList.shift()
                        recursiveCall(finalList)
                    })
                }
                recursiveCall([...finalList])

            } catch (error) {
                console.log(error)
            }

            // const final = await Promise.all(results.map(r => r.json()))
            // console.log(final)
            // location.reload()

        })
    })()
</script>